&nbsp;
<p align="center">
  <a href="https://cxtpl.github.io">
    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/9/91/Cpp-Francophonie.svg/512px-Cpp-Francophonie.svg.png" width="100px" alt="cxtpl" />
  </a>
</p>
<h3 align="center">C++ Template engine</h3>
<p align="center">Transpiles template into valid C++ code</p>
<hr />

![Open Source Love](https://img.shields.io/badge/Open%20Source-%E2%9D%A4-pink.svg)
![First Timers Only](https://img.shields.io/badge/first--timers--only-friendly-blue.svg?style=flat)
![Up For Grabs](https://img.shields.io/badge/up--for--grabs-friendly-green.svg?style=flat)
![GitHub](https://img.shields.io/github/license/blockspacer/CXTPL.svg)
![GitHub forks](https://img.shields.io/github/forks/blockspacer/CXTPL.svg)
![GitHub issues](https://img.shields.io/github/issues/blockspacer/CXTPL.svg)
![GitHub pull requests](https://img.shields.io/github/issues-pr/blockspacer/CXTPL.svg)
![GitHub contributors](https://img.shields.io/github/contributors/blockspacer/CXTPL.svg)
![GitHub commit activity the past week, 4 weeks, year](https://img.shields.io/github/commit-activity/w/blockspacer/CXTPL.svg)
![GitHub last commit](https://img.shields.io/github/last-commit/blockspacer/CXTPL.svg)
![GitHub top language](https://img.shields.io/github/languages/top/blockspacer/CXTPL.svg)
![GitHub language count](https://img.shields.io/github/languages/count/blockspacer/CXTPL.svg)
[![Project Status: WIP - Initial development is in progress, but there has not yet been a stable, usable release suitable for the public.](http://www.repostatus.org/badges/latest/wip.svg)](http://www.repostatus.org/#wip)
[![license](https://img.shields.io/github/license/blockspacer/CXTPL.svg?style=flat-square)](https://github.com/blockspacer/CXTPL/master/LICENSE)
[![Total alerts](https://img.shields.io/lgtm/alerts/g/bsamseth/cpp-project.svg?logo=lgtm&logoWidth=18)](https://lgtm.com/projects/g/blockspacer/CXTPL/alerts/)
[![Lines of Code](https://tokei.rs/b1/github/blockspacer/CXTPL)](https://github.com/Aaronepower/tokei).
[![Average time to resolve an issue](http://isitmaintained.com/badge/resolution/blockspacer/CXTPL.svg)](http://isitmaintained.com/project/blockspacer/CXTPL "Average time to resolve an issue")
[![Percentage of issues still open](http://isitmaintained.com/badge/open/blockspacer/CXTPL.svg)](http://isitmaintained.com/project/blockspacer/CXTPL "Percentage of issues still open")

# 📚 About CXTPL (C++ template engine)

Template engine with full C++ power (transpiles template into valid C++ code, supports Cling, etc.).

Note: This project is provided as it is, without any warranty (see License).

## What is `.cxtpl`

`.cxtpl` is a file extension for C++ template engine.

Example (more below):

```bash
<div> some template string here </div>
[[~ int valid_cpp_code_block_here = 0; ~]]
[[~]] int and_valid_cpp_code_line_here = 0;
<div> another template string here </div>
<div> C++ from template = [[* valid_cpp_code_block_here *]] </div>
```

You can pass C++ variables by pointers into cxtpl, this is very useful if you want to use complex data structures as template parameters.

C++ template engine transpiles template into C++ code, so you will gain VERY good performance and full power of C++.

C++ template engine may run in two modes:

- compile-mode: compiles cxtpl code into C++ file or std::string, then `#include` generated code & compiled app as usual. Best performance.
- cling-mode (C++ JIT executed at runtime): compiles cxtpl code into C++ file or std::string, then run generated code in Cling interpreter (no need to recompile app, useful in dev-mode or for php-style apps). See as example https://github.com/blockspacer/CXXCTP

## How to use C++ file generated by `.cxptl`

Again: Think about `.cxtpl` as lambda-function returning std::string. Prefer not to use `#include` from `.cxtpl`, just create `.cxtpl.h` file. Then `#include` both generated `.cxtpl.cpp` and created `.cxtpl.h` in your app code.

Code generated from `.cxtpl` must create a variable with the name `cxtpl_output`, so the structure of your code is as shown below:

```cpp
/// \Note that header is NOT generated, it includes stuff for other generated file
#include "../../resources/cxtpl/typeclass_instance_gen_hpp.cxtpl.h"

// ...

void somefunc() {
  std::string cxtpl_output;

  /// \Note this is a generated .cpp file, it must not use #include
  #include "../../resources/cxtpl/generated/typeclass_instance_gen_hpp.cxtpl.cpp"

  writeToFile(cxtpl_output, gen_hpp_name);
}
```

You need to `#include` all headers used by template generator in your app code. It is a good practice to create separate `.cxtpl.h` file near your `.cxtpl`. Separation of included files makes it possible to use same includes/logic both in compile-mode (just `#include` your `.cxtpl.h`) and cling-mode (pass contents of your `.cxtpl.h` as function argument). See `enum_gen_hpp.cxtpl.h` and `CXTPL_STD.h` as an example.

## Template syntax

`.cxtpl` uses approach similar to `How to write a template engine in less than 30 lines of code` from https://bits.theorem.co/how-to-write-a-template-library/

- `[[~` means `start execution of C++ code while parsing template`. Requires `~]]` as closing tag.
- `~]]` means `end execution of C++ code while parsing template`
- `[[~]]` means `start execution of C++ code while parsing template`. Requires newline (`\n`) as closing tag.
- `[[+` means `add result of execution of C++ code to output while parsing template`. Result must be string. Requires `+]]` as closing tag.
- `[[*` means `add result of execution of C++ code to output while parsing template`. Result will be converted to string (just wrapped in std::to_string). Requires `*]]` as closing tag.

Example before template parsing/transpiling:

```cpp
[[~ // parameters begin

const std::string generator_path = "somepath";

std::vector<std::string> generator_includes{"someinclude"};

// parameters end
/* no newline, see CX=l */ ~]][[~]]
// This is a generated file. Do not modify directly.
// Path to the code generator: [[+ generator_path +]].

[[~]] for(const auto& fileName: generator_includes) {
[[+ fileName /* CX=r used to append to cxtpl_output */ +]]
[[~]] } // end for
```

Example after template parsing/transpiling:

```cpp
// This is a generated file. Do not modify directly.
// Path to the code generator: somepath.

someinclude
```

useful links:

- https://bits.theorem.co/how-to-write-a-template-library/
- https://lambda.xyz/blog/maud-is-fast/
- https://dzone.com/articles/modern-type-safe-template-engines
- http://www.wilxoft.com/
- https://github.com/djc/askama
- https://www.reddit.com/r/rust/comments/b06z9m/cuach_a_compiletime_html_template_system/

### Clone code

```bash
# git submodule deinit --all -f
git submodule sync --recursive
git fetch --recurse-submodules
git submodule update --init --recursive --depth 5
# or
git submodule update --force --recursive --init --remote
```

## Install & use under Docker

Install and configure Docker https://medium.com/@saniaky/configure-docker-to-use-a-host-proxy-e88bd988c0aa

Clone code (as above) and `cd` into cloned dir.

NOTE: You may want to build Docker image with `--build-arg NO_SSL="False"`. Read comments in Dockerfile.

```bash
# Give docker the rights to access X-server
sudo -E xhost +local:docker

# build Dockerfile
sudo -E docker build --no-cache -t cpp-docker-cxtpl .

# Now let’s check if our image has been created.
sudo -E docker images

# Run in container without leaving host terminal
sudo -E docker run -v "$PWD":/home/u/cxtpl -w /home/u/cxtpl cpp-docker-cxtpl CXTPL_tool -version --version

# Run a terminal in container
sudo -E docker run --rm -v "$PWD":/home/u/cxtpl -w /home/u/cxtpl  -it  -e DISPLAY         -v /tmp/.X11-unix:/tmp/.X11-unix  cpp-docker-cxtpl

# type in container terminal
CXTPL_tool -version --version
```

## Develop under Docker

```bash
# Run a terminal in container
sudo -E docker run --rm -v "$PWD":/home/u/cxtpl -w /home/u/cxtpl  -it  -e DISPLAY         -v /tmp/.X11-unix:/tmp/.X11-unix  cpp-docker-cxtpl

# An example of how to build (with Makefile generated from cmake) inside the container
# Mounts $PWD to /home/u/cxtpl and runs command
mkdir build
sudo -E docker run --rm -v "$PWD":/home/u/cxtpl -w /home/u/cxtpl/build cpp-docker-cxtpl cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_EXPORT_COMPILE_COMMANDS=ON ..

# Run resulting app in host OS:
# ./build/<app>
```

## DEPENDENCIES

- [Boost](https://www.boost.org/)

```bash
sudo add-apt-repository ppa:boost-latest/ppa
sudo apt-get update && sudo apt-get upgrade
aptitude search boost
sudo apt-get install libboost-dev
```

- MPI

```bash
sudo apt-get install openmpi-bin openmpi-common libopenmpi-dev
```

- CMake

```bash
bash scripts/install_cmake.sh
```

- g3log

```bash
bash scripts/install_g3log.sh
```

- gtest

```bash
bash scripts/install_gtest.sh
```

- gflags

```bash
bash scripts/install_gflags.sh
```

NOTE: need libunwind with -fPIC (POSITION_INDEPENDENT_CODE) support

```bash
bash scripts/install_libunwind.sh
```

- Folly

deps from https://github.com/facebook/folly#ubuntu-1604-lts

```bash
sudo apt-get install \
    libevent-dev \
    libdouble-conversion-dev \
    libgoogle-glog-dev \
    libgflags-dev \
    libiberty-dev \
    liblz4-dev \
    liblzma-dev \
    libsnappy-dev \
    zlib1g-dev \
    binutils-dev \
    libjemalloc-dev \
    libssl-dev \
    pkg-config
```

NOTE: we patched folly for clang support https://github.com/facebook/folly/issues/976

```bash
bash scripts/install_folly.sh
```

## Install conan - a crossplatform dependency manager for C++

```bash
pip install --index-url=https://pypi.python.org/simple/ --trusted-host pypi.org --trusted-host pypi.python.org --trusted-host files.pythonhosted.org wheel \
  && \
  pip install --index-url=https://pypi.python.org/simple/ --trusted-host pypi.org --trusted-host pypi.python.org --trusted-host files.pythonhosted.org virtualenv \
  && \
  pip install --index-url=https://pypi.python.org/simple/ --trusted-host pypi.org --trusted-host pypi.python.org --trusted-host files.pythonhosted.org conan \
  && \
  pip install --index-url=https://pypi.python.org/simple/ --trusted-host pypi.org --trusted-host pypi.python.org --trusted-host files.pythonhosted.org conan_package_tools

conan profile new default --detect
# conan profile update settings.compiler.libcxx=libstdc++11 default

conan remote list

conan search *boost* -r all
```

Configure Proxies & cacert_path in `~/.conan/conan.conf`, see https://docs.conan.io/en/latest/reference/config_files/conan.conf.html#proxies

Configure conan clang profile to then use --profile clang:

```bash
/usr/bin/clang-6.0 -v
/usr/bin/clang++-6.0 -v

nano ~/.conan/profiles/clang

[settings]
# We are building in Ubuntu Linux
os_build=Linux
os=Linux
arch_build=x86_64
arch=x86_64

compiler=clang
compiler.version=6.0
compiler.libcxx=libstdc++11

[env]
CC=/usr/bin/clang
CXX=/usr/bin/clang++
```

And then `conan install ***** --profile clang`

```bash
/usr/bin/gcc -v
/usr/bin/g++ -v

nano ~/.conan/profiles/gcc

[settings]
# We are building in Ubuntu Linux
os_build=Linux
os=Linux
arch_build=x86_64
arch=x86_64

compiler=gcc
compiler.version=7
compiler.libcxx=libstdc++11

[env]
CC=/usr/bin/gcc
CXX=/usr/bin/g++
```

If you want to disable ssl (under proxy, etc.):

```bash
# see https://docs.conan.io/en/latest/reference/commands/misc/remote.html#conan-remote
conan remote update conan-center https://conan.bintray.com False
conan search boost* -r=conan-center

conan remote add bincrafters https://api.bintray.com/conan/bincrafters/public-conan
conan remote update bincrafters https://api.bintray.com/conan/bincrafters/public-conan False
conan search boost* -r=bincrafters
```

If you want to set corp. cacert:

```bash
CONAN_CACERT_PATH=/path/to/ca-bundle.crt
file $CONAN_CACERT_PATH
```

Useful links:

- https://ncona.com/2019/04/dependency-management-in-cpp-with-conan/
- https://blog.conan.io/2018/06/11/Transparent-CMake-Integration.html
- Conan https://blog.conan.io/2018/06/11/Transparent-CMake-Integration.html https://blog.conan.io/2018/12/03/Using-Facebook-Folly-with-Conan.html
- CONAN_PKG::cppzmq https://github.com/chaplin89/prontocpp/blob/master/CMakeLists.txt#L42
- https://github.com/conan-io/examples

## How to build

```bash
# tested with gcc
export CC=gcc
export CXX=g++
```

```bash
# create build dir
cmake -E remove_directory build
cmake -E make_directory build
```

```bash
cmake -E chdir build conan install --build=missing --profile gcc -o enable_tests=False ..
# configure
cmake -E chdir build cmake -E time cmake -DBUILD_EXAMPLES=FALSE -DENABLE_CLING=FALSE -DCMAKE_BUILD_TYPE=Debug ..
# build
cmake -E chdir build cmake -E time cmake --build . -- -j6
```

```bash
# (optional) check examples
# cmake -E time cmake -E chdir build/examples/simple/ ./CXTPL_examples_simple
# cmake -E time cmake -E chdir build/examples/cmake_integration/ ./CXTPL_examples_cmake_integration
```

```bash
# install lib and CXTPL_tool
sudo cmake -E chdir build make install
CXTPL_tool --help
```

```bash
# run CXTPL_tool
cmake -E time cmake -E chdir build/tool ./CXTPL_tool --help
```

```bash
# example input
echo "file1.cxtpl" >> build/file1.cxtpl
echo "file2.cxtpl" >> build/file2.cxtpl
echo "file3.cxtpl" >> build/file3.cxtpl
echo "file4.cxtpl" >> build/file4.cxtpl
cmake -E time ./build/tool/CXTPL_tool --threads 6 --input_files build/file1.cxtpl build/file2.cxtpl --output_files build/file1.cxtpl.generated.cpp build/file2.cxtpl.generated.cpp
```

## How to use CXTPL_tool

`--help` for list of available command line options

`--input_files` for input files.

`--output_files` for output files. If not set, than output file names will generated based on input file names.

Number of input files must be equal to the number of output files. File order is important.

```bash
./build/tool/CXTPL_tool --threads 6 --input_files build/file1.cxtpl build/file2.cxtpl build/file3.cxtpl build/file4.cxtpl --output_files build/file1.cxtpl.generated.cpp build/file2.cxtpl.generated.cpp build/file3.cxtpl.generated.cpp build/file4.cxtpl.generated.cpp -L ".=DBG9"
```

`-L .=DBG9` is log configuration in format https://github.com/facebook/folly/blob/master/folly/logging/docs/Config.md

Example of log configuration which writes both into the file and console stream:

```bash
./build/tool/CXTPL_tool --threads 6 --input_files build/file1.cxtpl build/file2.cxtpl --output_files build/file1.cxtpl.generated.cpp build/file2.cxtpl.generated.cpp j -L ".:=INFO:default:console; default=file:path=y.log,async=true,sync_level=DBG9;console=stream:stream=stderr"
```

`--srcdir` to change current filesystem path for input files.

`--resdir` to change current filesystem path for output files.

`--global_timeout_ms` to limit execution time for input files (performs check after task completion to stop other tasks from running).

`--single_task_timeout_ms` to limit execution time for singe input file (performs check after task completion to stop other tasks from running).

`--version` to get tool version

## How to use with CMake project

Suppose you need to generate code based on template files before building `TARGET_NAME_HERE`.

Add path to `cmake/exports` to your CMAKE_MODULE_PATH:

```bash
# replace path/to/CXTPL with yours
list(APPEND CMAKE_MODULE_PATH path/to/CXTPL/cmake/exports)
```

Specify files for code generation:

```bash
set(cxtpl_in_dir "${CMAKE_CURRENT_SOURCE_DIR}/resources/cxtpl")
set(cxtpl_out_dir "${CMAKE_CURRENT_SOURCE_DIR}/resources/cxtpl/generated")

list(APPEND cxtpl_inputs "${cxtpl_in_dir}/enum_gen_hpp.cxtpl")
list(APPEND cxtpl_inputs "${cxtpl_in_dir}/enum_gen_cpp.cxtpl")

list(APPEND cxtpl_outputs "${cxtpl_out_dir}/enum_gen_hpp.cxtpl.cpp")
list(APPEND cxtpl_outputs "${cxtpl_out_dir}/enum_gen_cpp.cxtpl.cpp")
```

Macro `target_add_CXTPL_tool` will invoke `CXTPL_tool` on `TARGET_NAME_HERE`:

```bash
find_package(CXTPL_tool REQUIRED)

# create new codegen files for TARGET_NAME_HERE based on cxtpl_inputs and cxtpl_outputs
target_add_CXTPL_tool(TARGET_NAME_HERE "${cxtpl_inputs}" "${cxtpl_outputs}")
```

See examples/cmake_integration

## Projects that use `.cxtpl`

- [CXXCTP](https://github.com/blockspacer/CXXCTP) is a transpiler that extends C++ for new introspection, reflection and compile-time execution.

## Project status

In development

Currently supports only linux.

Note that you can run linux containers under windows, mac, etc.

## About cling

You can use cling to execute C++ at compile-time/run-time, for hot code reload / REPL / Fast C++ prototyping / Scripting engine / JIT / etc.

useful links:

- (how to add Cling into CMake project) https://github.com/derofim/cling-cmake
- https://github.com/root-project/cling/tree/master/www/docs/talks
- https://github.com/caiorss/C-Cpp-Notes/blob/master/Root-cern-repl.org

## RTTI

RTTI enabled only in command line tool (CXTPL_tool), RTTI required by boost.po.

CXTPL library disabled RTTI and uses BOOST_NO_RTTI/BOOST_NO_TYPEID (as private cmake config).

## ⭐️ How to Contribute

Please read our [contributing](CONTRIBUTING.md) guidelines before making your pull request.

## Code of Conduct

Please note that this project is released with a [Code of Conduct](CODE_OF_CONDUCT.md). By participating in this project you agree to abide by its terms.

### Contributors List: Example Profile

- I'm an example that you can copy, if you want :)
- I work on many things like...
- My hobbies include...
- [![twitter-alt][twitter-img]](https://twitter.com/example)
  [![facebook-alt][facebook-img]](https://facebook.com/example)
  [![google-img][google-img]](https://plus.google.com/+Example)
  [![tumblr-alt][tumblr-img]](https://example.tumblr.com)
  [![dribbble-alt][dribbble-img]](https://dribbble.com/example)
  [![github-alt][github-img]](https://github.com/example)
  [![freeCodeCamp](imgs/freecodecamp.png)](https://www.freecodecamp.org/example)
  [<img src="imgs/linkedin.svg" width="20" height="20">](https://www.linkedin.com/in/example/)

### Contributors List 👌

### FarzanHosseini
-  [![github-alt][github-img]](https://github.com/farzanhosseini)

### D

#### Denis trofimov

- C++ Developer
- [![github-alt][github-img]](https://github.com/blockspacer)
- [![github-alt][github-img]](https://github.com/derofim)
- [<img src="imgs/linkedin.svg" width="20" height="20">](https://www.linkedin.com/in/denis-trofimov-4335bb13b/)

## Similar projects

- (compile-time) https://github.com/burner/sweet.hpp/tree/master/amber
- (compile-time) https://github.com/evgeny-panasyuk/ctte
- (compile-time) https://github.com/rep-movsd/see-phit
- (run-time) https://github.com/no1msd/mstch
- (run-time) https://github.com/henryr/cpp-mustache
- (run-time) https://github.com/pantor/inja
- (run-time) https://github.com/jinja2cpp/Jinja2Cpp
- (Rust) Type-safe, compiled Jinja-like templates for Rust https://github.com/djc/askama
- (article) https://dzone.com/articles/modern-type-safe-template-engines

[twitter-alt]: Twitter
[facebook-alt]: Facebook
[google-alt]: Google+
[tumblr-alt]: Tumblr
[dribbble-alt]: Dribbble
[github-alt]: GitHub

[twitter-img]: https://i.imgur.com/wWzX9uB.png
[facebook-img]: https://i.imgur.com/fep1WsG.png
[google-img]: https://i.imgur.com/VlgBKQ9.png
[tumblr-img]: https://i.imgur.com/jDRp47c.png
[dribbble-img]: https://i.imgur.com/Vvy3Kru.png
[github-img]: https://i.imgur.com/9I6NRUm.png
